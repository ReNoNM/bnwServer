<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Time Manager Test Client</title>
    <style>
      body {
        font-family: "Segoe UI", Arial, sans-serif;
        margin: 0;
        padding: 20px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
      }

      h1 {
        color: white;
        text-align: center;
        margin-bottom: 30px;
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
      }

      .card {
        background: white;
        border-radius: 10px;
        padding: 20px;
        margin-bottom: 20px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
      }

      .connection-panel {
        display: flex;
        gap: 10px;
        align-items: center;
        margin-bottom: 20px;
      }

      input[type="text"],
      input[type="email"],
      input[type="password"] {
        flex: 1;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 5px;
        font-size: 14px;
      }

      button {
        padding: 10px 20px;
        background: linear-gradient(135deg, #667eea, #764ba2);
        color: white;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-weight: bold;
        transition: transform 0.2s;
      }

      button:hover:not(:disabled) {
        transform: translateY(-2px);
      }

      button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }

      .status {
        display: inline-block;
        padding: 5px 10px;
        border-radius: 5px;
        font-weight: bold;
        margin-left: 10px;
      }

      .status.connected {
        background: #4caf50;
        color: white;
      }

      .status.disconnected {
        background: #f44336;
        color: white;
      }

      .cycle-display {
        font-size: 48px;
        font-weight: bold;
        text-align: center;
        color: #667eea;
        margin: 20px 0;
      }

      .cycle-info {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
        margin-top: 20px;
      }

      .info-item {
        background: #f5f5f5;
        padding: 15px;
        border-radius: 8px;
        text-align: center;
      }

      .info-label {
        color: #666;
        font-size: 12px;
        margin-bottom: 5px;
      }

      .info-value {
        color: #333;
        font-size: 24px;
        font-weight: bold;
      }

      .task-panel {
        display: flex;
        gap: 10px;
        align-items: center;
        margin-top: 20px;
      }

      .task-list {
        margin-top: 20px;
        max-height: 200px;
        overflow-y: auto;
      }

      .task-item {
        background: #f9f9f9;
        padding: 10px;
        border-radius: 5px;
        margin-bottom: 10px;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .countdown {
        color: #667eea;
        font-weight: bold;
      }

      #messages {
        background: #f5f5f5;
        padding: 15px;
        border-radius: 8px;
        max-height: 300px;
        overflow-y: auto;
        margin-top: 20px;
      }

      .message {
        padding: 8px;
        margin-bottom: 5px;
        border-left: 3px solid #667eea;
        background: white;
        border-radius: 3px;
        font-size: 14px;
      }

      .message.error {
        border-left-color: #f44336;
        background: #ffebee;
      }

      .message.success {
        border-left-color: #4caf50;
        background: #e8f5e9;
      }

      .auth-panel {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
      }

      .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 10px;
        margin-top: 20px;
      }

      .stat-item {
        background: #f0f0f0;
        padding: 10px;
        border-radius: 5px;
        text-align: center;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>üïê Time Manager Test Client</h1>

      <!-- –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ -->
      <div class="card">
        <h2>–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ</h2>
        <div class="connection-panel">
          <input type="text" id="serverUrl" value="ws://localhost:3000" placeholder="WebSocket URL" />
          <button id="connectBtn">–ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è</button>
          <button id="disconnectBtn" disabled>–û—Ç–∫–ª—é—á–∏—Ç—å—Å—è</button>
          <span class="status disconnected" id="connectionStatus">–û—Ç–∫–ª—é—á–µ–Ω–æ</span>
        </div>
      </div>

      <!-- –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è -->
      <div class="card" id="authCard" style="display: none">
        <h2>–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è</h2>
        <div class="auth-panel">
          <div>
            <h3>–í—Ö–æ–¥</h3>
            <input type="email" id="loginEmail" placeholder="Email" />
            <input type="password" id="loginPassword" placeholder="–ü–∞—Ä–æ–ª—å" style="margin-top: 10px" />
            <button id="loginBtn" style="margin-top: 10px; width: 100%">–í–æ–π—Ç–∏</button>
          </div>
          <div>
            <h3>–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</h3>
            <input type="email" id="registerEmail" placeholder="Email" />
            <input type="password" id="registerPassword" placeholder="–ü–∞—Ä–æ–ª—å" style="margin-top: 10px" />
            <button id="registerBtn" style="margin-top: 10px; width: 100%">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</button>
          </div>
        </div>
      </div>

      <!-- –ò–≥—Ä–æ–≤–æ–π —Ü–∏–∫–ª -->
      <div class="card" id="cycleCard" style="display: none">
        <h2>–ò–≥—Ä–æ–≤–æ–π —Ü–∏–∫–ª</h2>
        <div class="cycle-display" id="cycleDisplay">–¶–∏–∫–ª: 0</div>
        <div class="cycle-info">
          <div class="info-item">
            <div class="info-label">–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ</div>
            <div class="info-value" id="lastUpdate">-</div>
          </div>
          <div class="info-item">
            <div class="info-label">–°–ª–µ–¥—É—é—â–∏–π —Ü–∏–∫–ª —á–µ—Ä–µ–∑</div>
            <div class="info-value countdown" id="nextCycle">-</div>
          </div>
          <div class="info-item">
            <div class="info-label">–ò–Ω—Ç–µ—Ä–≤–∞–ª</div>
            <div class="info-value" id="cycleInterval">30 —Å–µ–∫</div>
          </div>
        </div>

        <div style="margin-top: 20px">
          <button id="getCycleBtn">–ü–æ–ª—É—á–∏—Ç—å —Ç–µ–∫—É—â–∏–π —Ü–∏–∫–ª</button>
          <button id="getStatsBtn">–ü–æ–ª—É—á–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É</button>
          <input type="number" id="newInterval" value="30" min="1" max="3600" style="width: 80px; margin-left: 10px" />
          <button id="setIntervalBtn">–ò–∑–º–µ–Ω–∏—Ç—å –∏–Ω—Ç–µ—Ä–≤–∞–ª</button>
        </div>
      </div>

      <!-- –¢–µ—Å—Ç–æ–≤—ã–µ –∑–∞–¥–∞—á–∏ -->
      <div class="card" id="tasksCard" style="display: none">
        <h2>–¢–µ—Å—Ç–æ–≤—ã–µ –∑–∞–¥–∞—á–∏</h2>
        <div class="task-panel">
          <input type="number" id="taskDelay" value="10" min="1" max="300" placeholder="–ó–∞–¥–µ—Ä–∂–∫–∞ (—Å–µ–∫)" />
          <input type="text" id="taskMessage" value="–¢–µ—Å—Ç–æ–≤–∞—è –∑–∞–¥–∞—á–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ" />
          <button id="createTaskBtn">–°–æ–∑–¥–∞—Ç—å –∑–∞–¥–∞—á—É</button>
        </div>
        <div class="task-list" id="taskList"></div>
      </div>

      <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
      <div class="card" id="statsCard" style="display: none">
        <h2>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ TimeManager</h2>
        <div class="stats-grid" id="statsGrid">
          <!-- –ó–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
        </div>
      </div>

      <!-- –°–æ–æ–±—â–µ–Ω–∏—è -->
      <div class="card">
        <h2>–°–æ–æ–±—â–µ–Ω–∏—è</h2>
        <button id="clearMessages">–û—á–∏—Å—Ç–∏—Ç—å</button>
        <div id="messages"></div>
      </div>
    </div>

    <script>
      let socket = null;
      let isAuthenticated = false;
      let currentCycle = 0;
      let cycleInterval = 30;
      let nextCycleTime = null;
      let tasks = new Map();

      // –≠–ª–µ–º–µ–Ω—Ç—ã DOM
      const serverUrl = document.getElementById("serverUrl");
      const connectBtn = document.getElementById("connectBtn");
      const disconnectBtn = document.getElementById("disconnectBtn");
      const connectionStatus = document.getElementById("connectionStatus");
      const messages = document.getElementById("messages");
      const authCard = document.getElementById("authCard");
      const cycleCard = document.getElementById("cycleCard");
      const tasksCard = document.getElementById("tasksCard");
      const statsCard = document.getElementById("statsCard");
      const cycleDisplay = document.getElementById("cycleDisplay");
      const lastUpdate = document.getElementById("lastUpdate");
      const nextCycle = document.getElementById("nextCycle");
      const cycleIntervalDisplay = document.getElementById("cycleInterval");
      const taskList = document.getElementById("taskList");
      const statsGrid = document.getElementById("statsGrid");

      // –§—É–Ω–∫—Ü–∏—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏—è
      function addMessage(text, type = "info") {
        const msg = document.createElement("div");
        msg.className = `message ${type}`;
        msg.textContent = `[${new Date().toLocaleTimeString()}] ${text}`;
        messages.insertBefore(msg, messages.firstChild);

        // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–æ–æ–±—â–µ–Ω–∏–π
        while (messages.children.length > 50) {
          messages.removeChild(messages.lastChild);
        }
      }

      // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–∞–π–º–µ—Ä–∞ –¥–æ —Å–ª–µ–¥—É—é—â–µ–≥–æ —Ü–∏–∫–ª–∞
      function updateCountdown() {
        if (nextCycleTime) {
          const remaining = Math.max(0, Math.floor((nextCycleTime - Date.now()) / 1000));
          nextCycle.textContent = `${remaining} —Å–µ–∫`;
        }

        // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–∞–π–º–µ—Ä—ã –∑–∞–¥–∞—á
        tasks.forEach((task, id) => {
          const remaining = Math.max(0, Math.floor((task.executeAt - Date.now()) / 1000));
          const countdownEl = document.getElementById(`countdown-${id}`);
          if (countdownEl) {
            countdownEl.textContent = `${remaining} —Å–µ–∫`;
          }
          if (remaining === 0) {
            tasks.delete(id);
            updateTaskList();
          }
        });
      }

      // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –∑–∞–¥–∞—á
      function updateTaskList() {
        taskList.innerHTML = "";
        tasks.forEach((task, id) => {
          const item = document.createElement("div");
          item.className = "task-item";
          item.innerHTML = `
                    <span>${task.message}</span>
                    <span class="countdown" id="countdown-${id}">-</span>
                    <button onclick="cancelTask('${id}')">–û—Ç–º–µ–Ω–∏—Ç—å</button>
                `;
          taskList.appendChild(item);
        });
      }

      // –û—Ç–º–µ–Ω–∞ –∑–∞–¥–∞—á–∏
      window.cancelTask = function (taskId) {
        if (socket && socket.readyState === WebSocket.OPEN) {
          socket.send(
            JSON.stringify({
              action: "time/cancelTask",
              data: { taskId },
            })
          );
        }
      };

      // –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —Å–µ—Ä–≤–µ—Ä—É
      connectBtn.addEventListener("click", () => {
        const url = serverUrl.value;
        if (!url) {
          addMessage("–í–≤–µ–¥–∏—Ç–µ URL —Å–µ—Ä–≤–µ—Ä–∞", "error");
          return;
        }

        try {
          socket = new WebSocket(url);

          socket.onopen = () => {
            connectionStatus.textContent = "–ü–æ–¥–∫–ª—é—á–µ–Ω–æ";
            connectionStatus.className = "status connected";
            connectBtn.disabled = true;
            disconnectBtn.disabled = false;
            authCard.style.display = "block";
            addMessage("–ü–æ–¥–∫–ª—é—á–µ–Ω–æ –∫ —Å–µ—Ä–≤–µ—Ä—É", "success");
          };

          socket.onclose = () => {
            connectionStatus.textContent = "–û—Ç–∫–ª—é—á–µ–Ω–æ";
            connectionStatus.className = "status disconnected";
            connectBtn.disabled = false;
            disconnectBtn.disabled = true;
            authCard.style.display = "none";
            cycleCard.style.display = "none";
            tasksCard.style.display = "none";
            statsCard.style.display = "none";
            isAuthenticated = false;
            addMessage("–û—Ç–∫–ª—é—á–µ–Ω–æ –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞", "error");
          };

          socket.onmessage = (event) => {
            try {
              const message = JSON.parse(event.data);
              handleMessage(message);
            } catch (e) {
              console.error("–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞:", e);
            }
          };

          socket.onerror = (error) => {
            addMessage(`–û—à–∏–±–∫–∞ WebSocket: ${error}`, "error");
          };
        } catch (error) {
          addMessage(`–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è: ${error}`, "error");
        }
      });

      // –û—Ç–∫–ª—é—á–µ–Ω–∏–µ –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞
      disconnectBtn.addEventListener("click", () => {
        if (socket) {
          socket.close();
        }
      });

      // –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—Ö–æ–¥—è—â–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
      function handleMessage(message) {
        const { action, data } = message;

        switch (action) {
          case "system/connect":
            addMessage(data.message, "success");
            break;

          case "auth/loginSuccess":
            isAuthenticated = true;
            authCard.style.display = "none";
            cycleCard.style.display = "block";
            tasksCard.style.display = "block";
            statsCard.style.display = "block";
            addMessage(`–í—Ö–æ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω: ${data.player.username}`, "success");
            // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º —Ç–µ–∫—É—â–∏–π —Ü–∏–∫–ª
            socket.send(JSON.stringify({ action: "time/getCycle" }));
            break;

          case "auth/loginFailed":
            addMessage(`–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞: ${data.error}`, "error");
            break;

          case "game/cycleUpdate":
            currentCycle = data.cycle;
            cycleDisplay.textContent = `–¶–∏–∫–ª: ${currentCycle}`;
            lastUpdate.textContent = new Date(data.timestamp).toLocaleTimeString();
            nextCycleTime = Date.now() + data.nextCycleIn * 1000;
            cycleInterval = data.nextCycleIn;
            cycleIntervalDisplay.textContent = `${cycleInterval} —Å–µ–∫`;
            addMessage(`–¶–∏–∫–ª –æ–±–Ω–æ–≤–ª–µ–Ω: ${currentCycle}`);
            break;

          case "time/getCycleSuccess":
            currentCycle = data.cycle;
            cycleDisplay.textContent = `–¶–∏–∫–ª: ${currentCycle}`;
            lastUpdate.textContent = new Date(data.timestamp).toLocaleTimeString();
            addMessage(`–¢–µ–∫—É—â–∏–π —Ü–∏–∫–ª: ${currentCycle}`, "success");
            break;

          case "time/setCycleIntervalSuccess":
            cycleInterval = data.interval;
            cycleIntervalDisplay.textContent = `${cycleInterval} —Å–µ–∫`;
            addMessage(data.message, "success");
            break;

          case "time/getStatsSuccess":
            updateStats(data);
            break;

          case "time/createTestTaskSuccess":
            tasks.set(data.taskId, {
              executeAt: data.executeAt,
              message: taskMessage.value,
            });
            updateTaskList();
            addMessage(data.message, "success");
            break;

          case "time/taskCompleted":
            addMessage(`‚úÖ ${data.message}`, "success");
            break;

          case "time/cancelTaskSuccess":
            tasks.delete(data.taskId);
            updateTaskList();
            addMessage(data.message, "success");
            break;

          case "system/ping":
            socket.send(
              JSON.stringify({
                action: "system/pong",
                data: { timestamp: Date.now() },
              })
            );
            break;

          default:
            if (action.includes("Failed")) {
              addMessage(`–û—à–∏–±–∫–∞: ${data.error || "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞"}`, "error");
            } else {
              addMessage(`${action}: ${JSON.stringify(data)}`);
            }
        }
      }

      // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
      function updateStats(stats) {
        statsGrid.innerHTML = "";

        const items = [
          { label: "–ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏–µ —Å–æ–±—ã—Ç–∏—è", value: stats.periodicEvents },
          { label: "–û–¥–Ω–æ—Ä–∞–∑–æ–≤—ã–µ —Å–æ–±—ã—Ç–∏—è", value: stats.onceEvents },
          { label: "Buckets", value: stats.buckets },
          { label: "–¢–µ–∫—É—â–∏–π —Ü–∏–∫–ª", value: stats.gameCycle.current },
          { label: "–ò–Ω—Ç–µ—Ä–≤–∞–ª —Ü–∏–∫–ª–∞", value: `${stats.gameCycle.interval} —Å–µ–∫` },
        ];

        items.forEach((item) => {
          const div = document.createElement("div");
          div.className = "stat-item";
          div.innerHTML = `
                    <div style="font-size: 12px; color: #666;">${item.label}</div>
                    <div style="font-size: 18px; font-weight: bold; color: #333;">${item.value}</div>
                `;
          statsGrid.appendChild(div);
        });

        addMessage("–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∞", "success");
      }

      // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–Ω–æ–ø–æ–∫
      document.getElementById("loginBtn").addEventListener("click", () => {
        const email = document.getElementById("loginEmail").value;
        const password = document.getElementById("loginPassword").value;

        if (!email || !password) {
          addMessage("–í–≤–µ–¥–∏—Ç–µ email –∏ –ø–∞—Ä–æ–ª—å", "error");
          return;
        }

        socket.send(
          JSON.stringify({
            action: "auth/login",
            data: { email, password },
          })
        );
      });

      document.getElementById("getCycleBtn").addEventListener("click", () => {
        socket.send(JSON.stringify({ action: "time/getCycle" }));
      });

      document.getElementById("getStatsBtn").addEventListener("click", () => {
        socket.send(JSON.stringify({ action: "time/getStats" }));
      });

      document.getElementById("setIntervalBtn").addEventListener("click", () => {
        const interval = parseInt(document.getElementById("newInterval").value);
        socket.send(
          JSON.stringify({
            action: "time/setCycleInterval",
            data: { interval },
          })
        );
      });

      document.getElementById("createTaskBtn").addEventListener("click", () => {
        const delay = parseInt(document.getElementById("taskDelay").value);
        const message = document.getElementById("taskMessage").value;

        socket.send(
          JSON.stringify({
            action: "time/createTestTask",
            data: { delay, message },
          })
        );
      });

      document.getElementById("clearMessages").addEventListener("click", () => {
        messages.innerHTML = "";
      });

      // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫–∏ –∫–∞–∂–¥—É—é —Å–µ–∫—É–Ω–¥—É
      setInterval(updateCountdown, 1000);
    </script>
  </body>
</html>
